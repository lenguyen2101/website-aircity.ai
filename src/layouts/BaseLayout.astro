---
import "../styles/global.css";
import Header from "../components/common/Header.astro";
import Footer from "../components/common/Footer.astro";
import { getLangFromUrl } from "../i18n/utils";
import Analytics from "@vercel/analytics/astro";

const lang = getLangFromUrl(Astro.url);

interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: "website" | "article";
  fullWidth?: boolean;
}

const {
  title,
  description = "AirCity - Nền tảng quản lý tòa nhà thông minh hàng đầu Việt Nam, ứng dụng AI & IoT để tối ưu vận hành và nâng cao trải nghiệm cư dân.",
  image = "/og-image.jpg",
  type = "website",
  fullWidth = false,
} = Astro.props;

const canonicalURL = new URL(
  Astro.url.pathname,
  Astro.site || Astro.url.origin
);
const socialImageURL = new URL(image, Astro.url);

// i18n hreflang logic
const pathname = Astro.url.pathname;
const siteUrl =
  Astro.site?.toString().replace(/\/$/, "") || "https://aircity.ai";
let viPath: string, enPath: string;
if (pathname.startsWith("/en/") || pathname === "/en") {
  enPath = pathname;
  viPath = pathname.replace(/^\/en\/?/, "/") || "/";
} else {
  viPath = pathname;
  enPath = `/en${pathname === "/" ? "" : pathname}`;
}
---

<!DOCTYPE html>
<html lang={lang} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="generator" content={Astro.generator} />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={socialImageURL} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <!-- Fonts: Self-hosted via @fontsource in global.css -->

    <!-- i18n hreflang tags -->
    <link rel="alternate" hreflang="vi" href={`${siteUrl}${viPath}`} />
    <link rel="alternate" hreflang="en" href={`${siteUrl}${enPath}`} />
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}${viPath}`} />

    <!-- Vercel Web Analytics -->
    <Analytics />

    <!-- JSON-LD Structured Data -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "Organization",
            name: "AirCity",
            url: "https://aircity.ai",
            logo: "https://aircity.ai/logo.png",
            description:
              "Nền tảng quản lý tòa nhà thông minh hàng đầu Việt Nam, ứng dụng AI & IoT.",
            address: {
              "@type": "PostalAddress",
              streetAddress: "65 Mai Chí Thọ, Phường Bình Trưng",
              addressLocality: "TP. Hồ Chí Minh",
              addressCountry: "VN",
            },
            telephone: "028 3970 6884",
            email: "hello@aircity.ai",
            sameAs: [
              "https://facebook.com/aircity.ai",
              "https://linkedin.com/company/aircity",
              "https://youtube.com/@aircity",
            ],
          },
          {
            "@type": "WebSite",
            name: "AirCity",
            url: "https://aircity.ai",
            inLanguage: ["vi", "en"],
          },
        ],
      })}
    ></script>
  </head>

  <Header />
  <main class:list={["min-h-screen pt-20", !fullWidth && "overflow-x-hidden"]}>
    <slot />
  </main>
  <Footer />

  <!-- Scroll Reveal Script -->
  <script>
    // Only verify if we have elements to animate, otherwise this script is lightweight enough
    const observerOptions = {
      threshold: 0.1,
      rootMargin: "0px 0px -50px 0px",
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add("revealed");
          observer.unobserve(entry.target);
        }
      });
    }, observerOptions);

    document.querySelectorAll(".animate-reveal").forEach((el) => {
      observer.observe(el);
    });
  </script>

</html>
