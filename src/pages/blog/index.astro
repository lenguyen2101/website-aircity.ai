---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
);

const categoryLabels: Record<string, string> = {
  technology: "Công nghệ",
  insights: "Insights",
  product: "Sản phẩm",
  news: "Tin tức",
  press: "Báo chí & Đối tác",
  updates: "Cập nhật Công ty",
};

const categoryColors: Record<string, string> = {
  technology:
    "bg-primary-600 text-white border-primary-500/50 shadow-lg shadow-primary-900/20",
  insights:
    "bg-purple-600 text-white border-purple-500/50 shadow-lg shadow-purple-900/20",
  product:
    "bg-cyan-600 text-white border-cyan-500/50 shadow-lg shadow-cyan-900/20",
  news: "bg-emerald-600 text-white border-emerald-500/50 shadow-lg shadow-emerald-900/20",
  press:
    "bg-blue-600 text-white border-blue-500/50 shadow-lg shadow-blue-900/20",
  updates:
    "bg-indigo-600 text-white border-indigo-500/50 shadow-lg shadow-indigo-900/20",
};

function formatDate(date: Date): string {
  return date.toLocaleDateString("vi-VN", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

function estimateReadTime(body: string): number {
  const words = body.split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 200));
}
---

<BaseLayout
  title="Blog — AirCity"
  description="Cập nhật kiến thức, xu hướng công nghệ, và insights về Smart Building, AI, IoT từ đội ngũ AirCity."
>
  <!-- Page Hero -->
  <section class="relative pt-32 pb-0 overflow-hidden">
    <div class="absolute inset-0">
      <div
        class="absolute inset-0 bg-gradient-to-b from-dark-950 via-dark-900 to-dark-950"
      >
      </div>
      <div class="grid-pattern"></div>
      <div
        class="absolute top-1/3 left-1/2 -translate-x-1/2 w-[600px] h-[400px] bg-accent-purple/8 rounded-full blur-[120px]"
      >
      </div>
    </div>

    <div class="section-container relative z-10">
      <div class="max-w-3xl mx-auto text-center">
        <div
          class="animate-reveal inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-accent-purple/10 border border-accent-purple/20 mb-6"
        >
          <span
            class="text-accent-purple text-xs font-semibold uppercase tracking-wider"
            >Blog</span
          >
        </div>
        <h1
          class="animate-reveal text-4xl md:text-5xl lg:text-6xl font-bold text-primary mb-6"
          style="animation-delay: 0.1s;"
        >
          Kiến thức & <span class="gradient-text-purple">Xu hướng</span>
        </h1>
        <p
          class="animate-reveal text-secondary text-lg leading-relaxed"
          style="animation-delay: 0.2s;"
        >
          Cập nhật những xu hướng mới nhất về Smart Building, AI, IoT và kinh
          nghiệm thực tiễn từ đội ngũ AirCity.
        </p>
      </div>
    </div>
  </section>

  <!-- Blog Grid -->
  <section class="py-12 relative">
    <div class="section-container">
      {
        posts.length === 0 ? (
          <div class="text-center py-20">
            <p class="text-slate-500 text-lg">
              Chưa có bài viết nào. Hãy quay lại sau!
            </p>
          </div>
        ) : (
          <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {posts.map((post, index) => (
              <a
                href={`/blog/${post.id.replace(/\.mdx?$/, "")}`}
                class={`${
                  index < 3 ? "" : "animate-reveal"
                } glass-card overflow-hidden group`}
                style={
                  index < 3 ? "" : `animation-delay: ${0.05 * (index - 2)}s;`
                }
              >
                {/* Image Area */}
                <div class="relative h-48 bg-dark-800 overflow-hidden">
                  <div class="absolute inset-0 bg-gradient-to-br from-dark-800 to-dark-700 flex items-center justify-center placeholder-bg">
                    <div class="absolute inset-0 bg-gradient-to-br from-primary-500/10 to-accent-purple/10 group-hover:from-primary-500/20 group-hover:to-accent-purple/20 transition-all duration-500" />
                    <svg
                      width="48"
                      height="48"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="0.5"
                      class="text-white/10"
                    >
                      <path
                        d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      />
                      <polyline points="14 2 14 8 20 8" />
                    </svg>
                  </div>
                  <img
                    src={post.data.image || "/images/blog/fallback.png"}
                    alt={post.data.title}
                    class="absolute inset-0 w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 z-0"
                    onload="this.parentElement.querySelector('.placeholder-bg').style.display='none'"
                    onerror="this.src='/images/blog/fallback.png'; this.onerror=null;"
                  />
                  {/* Category badge */}
                  <div
                    class={`absolute top-4 left-4 px-3 py-1 rounded-full text-xs font-semibold border z-10 ${
                      categoryColors[post.data.category]
                    }`}
                  >
                    {categoryLabels[post.data.category]}
                  </div>
                </div>

                {/* Content */}
                <div class="p-6">
                  <div class="flex items-center gap-3 text-sm text-slate-500 mb-3">
                    <span>{formatDate(post.data.publishDate)}</span>
                    <span>·</span>
                    <span>{estimateReadTime(post.body || "")} phút đọc</span>
                  </div>
                  <h3 class="text-lg font-semibold text-primary mb-2 group-hover:text-primary-400 transition-colors line-clamp-2">
                    {post.data.title}
                  </h3>
                  {post.data.category === "press" && post.data.source && (
                    <div class="text-xs text-primary-400/80 mb-3 font-medium">
                      Nguồn: {post.data.source}
                    </div>
                  )}

                  {/* Tags */}
                  <div class="flex flex-wrap gap-2 mt-4">
                    {post.data.tags.slice(0, 3).map((tag) => (
                      <span class="text-xs text-slate-500 bg-white/5 px-2 py-1 rounded">
                        #{tag}
                      </span>
                    ))}
                  </div>
                </div>
              </a>
            ))}
          </div>
        )
      }
    </div>
  </section>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
